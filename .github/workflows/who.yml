on: issue_comment

jobs:
  pr_commented:
    # This job only runs for pull request comments
    name: PR comment
    if: (github.event.comment.body == 'yay')
    runs-on: ubuntu-latest
    steps:
      - id: 'get-branch'
        run: echo ::set-output name=branch::$(gh pr view $PR_NO --repo $REPO --json headRefName --jq '.headRefName')
        env:
          REPO: ${{ github.repository }}
          PR_NO: ${{ github.event.issue.number }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ steps.get-branch.outputs.branch }}
      
      - name: Node install
        uses: actions/setup-node@v2
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Install JS Packages
        run: yarn
        
      - name: Build
        run: yarn build
      
      - name: Rsync
        uses: burnett01/rsync-deployments@4.1
        with:
          switches: -a
          path: public/
          remote_path: "/var/www/html/$BLAH.england.cityguessr.com"
          remote_host: "$BLAH.england.cityguessr.com"
          remote_user: deploy
          remote_key: ${{ secrets.DEPLOY_KEY }}
        env:
          NUMBER: ${{ github.event.issue.number }}
          BLAH: ${{ github.actor }}
          COMMENT: ${{ github.event.comment.body }}

      - name: Add comment to PR
        env:
          URL: ${{ github.event.issue.comments_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          USER: ${{ github.actor }}
          STORYBOOK_URL: "${{ github.actor }}.storybook.carlosfair.com"
        run: |
          curl \
            -X POST \
            $URL \
            -H "Content-Type: application/json" \
            -H "Authorization: token $GITHUB_TOKEN" \
            --data '{ "body": "'check it out at "$USER".storybook.carlosfair.com'"}'

  issue_commented:
    # This job only runs for issue comments
    name: Issue comment
    if: ${{ !github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo A comment on issue $NUMBER
        env:
          NUMBER: ${{ github.event.pull_request.head.ref }}
